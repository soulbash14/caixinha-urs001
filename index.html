<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Caixinha urs_001</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #0f172a; color: white; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .card { background: white; color: #333; border-radius: 20px; width: 100%; max-width: 400px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .hidden { display: none !important; }
        .btn-primary { background: #2563eb; border: none; padding: 12px; font-weight: bold; }
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; justify-content: center; align-items: center; }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner-border text-light"></div></div>

    <div class="card">
        <div id="view-login">
            <h3 class="fw-bold text-primary mb-4 text-center">Login</h3>
            <input type="text" id="user" class="form-control mb-2" placeholder="Usuário">
            <input type="password" id="pass" class="form-control mb-3" placeholder="Senha">
            <button class="btn btn-primary w-100 mb-3" onclick="App.login()">ENTRAR</button>
            <div class="d-flex justify-content-between">
                <button class="btn btn-link btn-sm p-0 text-decoration-none" onclick="App.show('view-cadastro')">Primeiro Acesso</button>
                <button class="btn btn-link btn-sm p-0 text-decoration-none text-danger" onclick="App.show('view-esqueci')">Esqueci Senha</button>
            </div>
        </div>

        <div id="view-cadastro" class="hidden">
            <h3 class="fw-bold text-success mb-3">Cadastro</h3>
            <p class="text-muted small">Valide seu CPF para continuar</p>
            <input type="text" id="reg-cpf" class="form-control mb-3" placeholder="CPF (apenas números)">
            <button class="btn btn-success w-100 mb-2" onclick="App.validarCPF()">Verificar CPF</button>
            <button class="btn btn-link btn-sm w-100" onclick="App.show('view-login')">Voltar</button>
        </div>

        <div id="view-finalizar" class="hidden">
            <h3 class="fw-bold text-primary mb-3">Dados de Acesso</h3>
            <p id="msg-boas-vindas" class="text-muted small"></p>
            <input type="hidden" id="reg-linha">
            <input type="text" id="reg-user" class="form-control mb-2" placeholder="Crie um Usuário">
            <input type="password" id="reg-pass" class="form-control mb-3" placeholder="Crie uma Senha">
            <button class="btn btn-primary w-100" onclick="App.salvar()">Concluir Cadastro</button>
        </div>

        <div id="view-esqueci" class="hidden">
            <h3 class="fw-bold text-danger mb-3">Recuperar</h3>
            <p class="text-muted small">Informe seu CPF cadastrado</p>
            <input type="text" id="esc-cpf" class="form-control mb-3" placeholder="CPF">
            <button class="btn btn-danger w-100 mb-2" onclick="App.recuperar()">Recuperar Senha</button>
            <button class="btn btn-link btn-sm w-100" onclick="App.show('view-login')">Voltar</button>
        </div>

        <div id="view-dash" class="hidden text-center">
            <h4 class="fw-bold mb-0">Olá, <span id="txt-nome" class="text-primary"></span></h4>
            <hr>
            <div class="p-3 bg-light rounded mb-3">
                <small class="text-muted">Seu Saldo</small>
                <h2 class="text-success fw-bold" id="txt-saldo">R$ 0,00</h2>
            </div>
            <button class="btn btn-outline-danger btn-sm w-100" onclick="location.reload()">SAIR</button>
        </div>
    </div>

    <script>
        const API = 'SUBSTITUA_PELA_SUA_URL_DO_GOOGLE_SCRIPT';

        const App = {
            show(id) {
                const views = ['view-login', 'view-cadastro', 'view-finalizar', 'view-esqueci', 'view-dash'];
                views.forEach(v => document.getElementById(v).classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
            },

            async request(action, payload) {
                document.getElementById('loader').style.display = 'flex';
                try {
                    const r = await fetch(API, { method: 'POST', body: JSON.stringify({action, payload}) });
                    return await r.json();
                } catch(e) {
                    alert("Erro de conexão!");
                    return { sucesso: false };
                } finally {
                    document.getElementById('loader').style.display = 'none';
                }
            },

            async login() {
                const res = await this.request('login', {
                    user: document.getElementById('user').value,
                    pass: document.getElementById('pass').value
                });
                if(res.sucesso) {
                    document.getElementById('txt-nome').innerText = res.nome;
                    document.getElementById('txt-saldo').innerText = "R$ " + res.saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    this.show('view-dash');
                } else { alert(res.msg); }
            },

            async validarCPF() {
                const res = await this.request('validarCpf', { cpf: document.getElementById('reg-cpf').value });
                if(res.sucesso) {
                    document.getElementById('msg-boas-vindas').innerText = "Olá " + res.nome + ", defina seu login:";
                    document.getElementById('reg-linha').value = res.linha;
                    this.show('view-finalizar');
                } else { alert(res.msg); }
            },

            async salvar() {
                const res = await this.request('salvar', {
                    linha: document.getElementById('reg-linha').value,
                    u: document.getElementById('reg-user').value,
                    s: document.getElementById('reg-pass').value
                });
                if(res.sucesso) { alert(res.msg); this.show('view-login'); }
            },

            async recuperar() {
                const res = await this.request('esqueciSenha', { cpf: document.getElementById('esc-cpf').value });
                alert(res.msg);
                if(res.sucesso) this.show('view-login');
            }
        };
    </script>
</body>
</html>
